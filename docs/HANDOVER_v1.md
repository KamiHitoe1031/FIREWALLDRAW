# FIREWALL DRAW 引継ぎ資料 v1

**最終更新**: 2026-01-26
**プロジェクト**: タワーディフェンス型ゲーム「FIREWALL DRAW」

---

## 目次

1. [プロジェクト概要](#1-プロジェクト概要)
2. [ディレクトリ構成](#2-ディレクトリ構成)
3. [技術スタック](#3-技術スタック)
4. [ゲーム仕様](#4-ゲーム仕様)
5. [実装済み機能](#5-実装済み機能)
6. [画像・スプライト仕様](#6-画像スプライト仕様)
7. [データ構造](#7-データ構造)
8. [現状の課題](#8-現状の課題)
9. [ネクストアクション](#9-ネクストアクション)
10. [開発環境・デプロイ](#10-開発環境デプロイ)

---

## 1. プロジェクト概要

### 1.1 ゲームコンセプト

「FIREWALL DRAW」は、プレイヤーが**マウスで壁を描いて**コンピュータウイルスからCPUを守るタワーディフェンスゲームです。

- **ジャンル**: タワーディフェンス × お絵かき
- **プラットフォーム**: Webブラウザ（PC向け）
- **画面サイズ**: 800 × 600 px

### 1.2 ゲームの流れ

```
タイトル画面 → ステージ選択 → ゲームプレイ → リザルト → ステージ選択...
                    ↓
              ヘルプ/図鑑
              ランキング
              データ編集
```

### 1.3 基本ルール

1. 画面中央のCPUを敵から守る
2. マウスドラッグで壁を描く（最大3本、5秒で消滅）
3. 敵が壁に触れるとダメージを受ける
4. 敵がCPUに到達するとCPU HPが減る
5. CPU HP が 0 になるとゲームオーバー
6. 全ウェーブをクリアするとステージクリア

---

## 2. ディレクトリ構成

```
firewall-draw/
├── index.html              # エントリーポイント
├── README.md               # プロジェクト説明
├── wrangler.json           # Cloudflare Pages設定
│
├── assets/
│   ├── data/               # ゲームデータ（JSON）
│   │   ├── enemies.json    # 敵定義（10種）
│   │   ├── stages.json     # ステージ定義（10面）
│   │   ├── walls.json      # 壁定義（5種）
│   │   └── upgrades.json   # アップグレード定義
│   ├── images/             # 画像アセット（現在空）
│   │   ├── backgrounds/
│   │   ├── enemies/
│   │   ├── ui/
│   │   └── walls/
│   └── audio/              # 音声アセット（現在空）
│       ├── bgm/
│       └── sfx/
│
├── css/
│   └── style.css           # スタイル定義
│
├── js/
│   ├── main.js             # ゲーム起動・設定
│   ├── AssetManager.js     # アセット管理（プレースホルダー対応）
│   ├── PlaceholderConfig.js # プレースホルダー設定
│   │
│   ├── data/
│   │   └── DefaultData.js  # フォールバックデータ
│   │
│   ├── scenes/
│   │   ├── BootScene.js    # 起動シーン
│   │   ├── PreloadScene.js # アセット読み込み
│   │   ├── TitleScene.js   # タイトル画面
│   │   ├── StageSelectScene.js # ステージ選択
│   │   ├── HelpScene.js    # ヘルプ・図鑑
│   │   ├── DataScene.js    # データ編集
│   │   ├── GameScene.js    # メインゲーム（Wall/Enemyクラス含む）
│   │   ├── UIScene.js      # HUDオーバーレイ
│   │   ├── ResultScene.js  # リザルト画面
│   │   └── RankingScene.js # ランキング画面
│   │
│   └── utils/
│       ├── SaveManager.js  # セーブデータ管理
│       └── RankingManager.js # ランキングAPI通信
│
├── workers/
│   ├── ranking-api.js      # Cloudflare Workers API
│   └── wrangler.toml       # Workers設定
│
└── docs/
    ├── visual_design_proposal.md # ビジュアルデザイン提案書
    └── HANDOVER_v1.md      # 本ファイル
```

---

## 3. 技術スタック

| カテゴリ | 技術 | バージョン |
|---------|------|-----------|
| ゲームエンジン | Phaser 3 | 3.80.0 (CDN) |
| 言語 | JavaScript | ES6+ |
| データ保存 | localStorage | - |
| ホスティング | Cloudflare Pages | - |
| バックエンドAPI | Cloudflare Workers | - |
| データベース | Cloudflare KV | - |

### 3.1 外部依存

```html
<!-- Phaser 3 CDN -->
<script src="https://cdn.jsdelivr.net/npm/phaser@3.80.0/dist/phaser.min.js"></script>
```

---

## 4. ゲーム仕様

### 4.1 定数設定（main.js）

```javascript
const GAME_CONFIG = {
  WIDTH: 800,           // キャンバス幅
  HEIGHT: 600,          // キャンバス高さ
  UI_TOP_HEIGHT: 50,    // 上部UI領域
  UI_BOTTOM_HEIGHT: 50, // 下部UI領域
  GAME_AREA_TOP: 50,    // ゲームエリア上端
  GAME_AREA_BOTTOM: 550,// ゲームエリア下端
  CPU_X: 400,           // CPU X座標
  CPU_Y: 300            // CPU Y座標
};
```

### 4.2 難易度設定

| 難易度 | 敵数倍率 | 敵HP倍率 | 壁最大長 | CPU HP |
|--------|---------|---------|---------|--------|
| Normal | 1.0 | 1.0 | 300px | 基本値 |
| Hard | 1.5 | 1.2 | 200px | 基本値-2 |

### 4.3 壁の仕様

| 項目 | 値 |
|------|-----|
| 最大本数 | 3本（+アップグレード） |
| 持続時間 | 5秒（+アップグレード） |
| 最小長さ | 50px |
| 最大長さ | 300px（Normal）/ 200px（Hard） |
| 太さ | 16px |
| 描画クールダウン | 500ms |

### 4.4 敵タイプ（10種）

| ID | 名前 | HP | 速度 | 報酬 | サイズ | 特殊能力 |
|----|------|-----|------|------|--------|----------|
| bug_small | バグ（小） | 10 | 80 | 5 | 24×24 | なし |
| bug_medium | バグ（中） | 25 | 60 | 15 | 32×32 | なし |
| worm | ワーム | 15 | 120 | 10 | 32×16 | 高速 |
| trojan | トロイ | 50 | 40 | 30 | 48×48 | 高耐久 |
| ransom | ランサム | 80 | 50 | 50 | 64×64 | 最高耐久 |
| bomber | ボマー | 20 | 80 | 25 | 40×40 | 壁破壊・自爆 |
| shield | シールド型 | 15 | 100 | 35 | 20×20 | 壁1回すり抜け |
| spawner | スポナー | 40 | 50 | 40 | 48×48 | 死亡時小型召喚 |
| stealth | ステルス型 | 12 | 120 | 30 | 20×20 | 2秒周期で透明化 |
| dasher | ダッシュ型 | 25 | 80 | 30 | 32×32 | 3秒周期で1秒加速 |

### 4.5 壁タイプ（5種）

| ID | 名前 | ダメージ | 色 | 効果 | 解禁ステージ | コスト |
|----|------|---------|-----|------|-------------|--------|
| basic | 基本の壁 | 10 | 水色 | なし | 1 | 0 |
| fire | 炎の壁 | 15 | オレンジ | DOT 3/500ms | 3 | 300 |
| ice | 氷の壁 | 5 | シアン | 80%減速 | 5 | 500 |
| thunder | 雷の壁 | 20 | 黄 | 高ダメージ | 7 | 700 |
| poison | 毒の壁 | 8 | 紫 | DOT 5/1000ms | 10 | 1000 |

### 4.6 ステージ構成（10面）

| ステージ | 名前 | CPU HP | 報酬 | Wave数 | 新敵 |
|----------|------|--------|------|--------|------|
| 1 | はじまりの防衛 | 10 | 100 | 4 | - |
| 2 | 東からの脅威 | 10 | 120 | 4 | - |
| 3 | 挟み撃ち | 10 | 150 | 4 | - |
| 4 | 爆発の脅威 | 10 | 180 | 4 | bomber |
| 5 | すり抜ける影 | 10 | 200 | 4 | shield |
| 6 | 増殖する悪夢 | 12 | 250 | 4 | spawner |
| 7 | 見えない恐怖 | 12 | 300 | 4 | stealth |
| 8 | 突進の嵐 | 12 | 350 | 4 | dasher |
| 9 | カオスウェーブ | 15 | 500 | 5 | - |
| 10 | 最終防衛戦 | 20 | 1000 | 6 | - |

### 4.7 アップグレードシステム

| ID | 効果 | 最大Lv | コスト |
|----|------|--------|--------|
| wall_duration | 壁持続+1秒/Lv | 5 | 100→200→400→800→1600 |
| wall_damage | 壁ダメージ+20%/Lv | 5 | 150→300→600→1200→2400 |
| wall_count | 壁本数+1/Lv | 2 | 500→1500 |
| cpu_hp | CPU HP+2/Lv | 5 | 100→200→400→800→1600 |

### 4.8 スコアシステム

**基本スコア**:
- 敵撃破: 敵の報酬値
- ウェーブクリア: +100点

**ボーナス**:
- **壁エコノミー**: 目標壁数以下でクリア
  - S（50%以下）: +2000点
  - A（75%以下）: +1000点
  - B（100%以下）: +500点
- **ノーダメージ**: +1000点
- **マルチキル**: 同じ壁で2体以上倒す → 撃破数×50点

**壁の長さ倍率**:
- 50px: ×2.0
- 150px: ×1.6
- 300px: ×1.0

---

## 5. 実装済み機能

### 5.1 コア機能

- [x] マウスドラッグによる壁描画
- [x] 壁と敵の衝突判定
- [x] ダメージ・スタン・減速・DOT処理
- [x] ウェーブ制の敵スポーン
- [x] 4方向からの侵入（top/bottom/left/right）
- [x] CPU HP管理・表情変化
- [x] ゲームオーバー・ステージクリア判定
- [x] スコア計算・ボーナス判定

### 5.2 特殊敵の能力

- [x] **bomber**: 壁に触れると壁を破壊して自爆
- [x] **shield**: 壁を1回だけすり抜け（isPassingThroughフラグ方式）
- [x] **spawner**: 死亡時にbug_smallを3体召喚
- [x] **stealth**: 2秒周期で透明化（alpha 0.2⇔1.0）
- [x] **dasher**: 3秒周期で1秒間3倍速

### 5.3 メタ機能

- [x] セーブ/ロード（localStorage）
- [x] 難易度選択（Normal/Hard）
- [x] コイン・アップグレードシステム
- [x] 壁タイプ解禁・購入
- [x] ヘルプ画面（スクロール対応）
- [x] 敵図鑑
- [x] データ編集画面（DOM統合）

### 5.4 オンライン機能

- [x] ランキングAPI（Cloudflare Workers + KV）
- [x] スコア送信
- [x] ランキング表示
- [x] プレイヤー名保存

### 5.5 エフェクト

- [x] 壁描画プレビュー（半透明）
- [x] 壁フェードアウト
- [x] 敵撃破パーティクル
- [x] ボマー爆発エフェクト + 画面揺れ
- [x] シールド消滅エフェクト
- [x] ステージクリア紙吹雪
- [x] マルチキルボーナス表示

---

## 6. 画像・スプライト仕様

### 6.1 現在の実装

現在は**プレースホルダー方式**で動作：
- 画像ファイルは存在しない
- `AssetManager.js`が画像の有無を判定
- 画像がなければ`PlaceholderConfig.js`の設定で図形を生成

### 6.2 Phaserのスプライトシート対応

**フレーム数制限**: **制限なし**（Phaser 3は任意のフレーム数に対応）

**読み込み方法**:
```javascript
// PreloadScene.js
this.load.spritesheet('enemy_worm', 'assets/images/enemies/worm.png', {
  frameWidth: 32,   // 1フレームの幅
  frameHeight: 16   // 1フレームの高さ
});
```

**スプライトシート形式**:
```
横一列に並べる（フレーム0, 1, 2, ...）
┌────┬────┬────┬────┐
│ F0 │ F1 │ F2 │ F3 │
└────┴────┴────┴────┘
 32px 32px 32px 32px
```

**アニメーション定義**:
```javascript
this.anims.create({
  key: 'worm_move',
  frames: this.anims.generateFrameNumbers('enemy_worm', { start: 0, end: 3 }),
  frameRate: 8,    // 8fps
  repeat: -1       // 無限ループ
});
```

### 6.3 推奨画像仕様

#### 敵キャラクター

| ID | 推奨サイズ | フレーム数 | 用途 |
|----|-----------|-----------|------|
| bug_small | 48×48 | 2 | 待機アニメ |
| bug_medium | 64×64 | 2 | 待機アニメ |
| worm | 64×32 | 4 | 蠕動アニメ |
| trojan | 96×96 | 2 | 待機アニメ |
| ransom | 128×128 | 4 | 威嚇アニメ |
| bomber | 80×80 | 2 | 点滅アニメ |
| shield | 48×48 | 2 | シールド光 |
| spawner | 96×96 | 4 | 脈動アニメ |
| stealth | 48×48 | 2 | 待機アニメ |
| dasher | 64×64 | 4 | 加速アニメ |

#### CPU/コア

| 要素 | サイズ | フレーム数 | 備考 |
|------|--------|-----------|------|
| 本体 | 128×128 | 1 | 静止画 |
| 表情 | 64×64 | 4 | 😊😰😨😱相当 |

#### 壁テクスチャ

| タイプ | サイズ | フレーム数 | 備考 |
|--------|--------|-----------|------|
| basic | 32×32 | 1 | タイル用 |
| fire | 32×32 | 4 | 炎アニメ |
| ice | 32×32 | 1 | 透明感 |
| thunder | 32×32 | 4 | 電撃アニメ |
| poison | 32×32 | 2 | 泡アニメ |

#### UI要素

| 要素 | サイズ | 備考 |
|------|--------|------|
| タイトルロゴ | 400×150 | PNG透過 |
| ボタン | 200×60 | 9-slice推奨 |
| 壁アイコン | 64×64 | 選択UI用 |
| 背景（タイトル） | 800×600 | PNG/JPG |
| 背景（ゲーム） | 800×600 | PNG/JPG |

#### エフェクト

| 要素 | サイズ | フレーム数 | 備考 |
|------|--------|-----------|------|
| 爆発 | 128×128 | 8 | ボマー用 |
| 撃破 | 16×16 | 1 | パーティクル |
| シールドオーラ | 64×64 | 2 | 半透明 |

### 6.4 画像追加時の手順

1. `assets/images/` に画像を配置
2. `PreloadScene.js` に読み込み処理を追加
3. 必要に応じてアニメーション定義を追加
4. `AssetManager.js` が自動で画像を使用（プレースホルダーより優先）

**例: 新しい敵画像を追加**

```javascript
// PreloadScene.js
this.load.spritesheet('enemy_bomber', 'assets/images/enemies/bomber.png', {
  frameWidth: 40,
  frameHeight: 40
});

// GameScene.js または別ファイルでアニメーション定義
this.anims.create({
  key: 'bomber_blink',
  frames: this.anims.generateFrameNumbers('enemy_bomber', { start: 0, end: 1 }),
  frameRate: 4,
  repeat: -1
});
```

---

## 7. データ構造

### 7.1 セーブデータ（localStorage）

**キー**: `firewall_draw_save`

```javascript
{
  normal: {
    clearedStages: [1, 2, 3],        // クリア済みステージID
    highScores: { "1": 5000, "2": 4500 }  // ハイスコア
  },
  hard: {
    clearedStages: [],
    highScores: {}
  },
  coins: 1500,                        // 所持コイン
  unlockedWalls: ["basic", "fire"],   // 解禁済み壁
  upgrades: {
    wall_duration: 2,
    wall_damage: 1,
    wall_count: 0,
    cpu_hp: 3
  }
}
```

### 7.2 ランキングAPI

**エンドポイント**: `https://firewall-ranking-api.eteandran.workers.dev`

| メソッド | パス | 説明 |
|---------|------|------|
| POST | /submit | スコア送信 |
| GET | /rankings | ランキング取得 |
| GET | /best-scores | 全ステージベストスコア |

**リクエスト例（スコア送信）**:
```javascript
{
  playerName: "プレイヤー名",
  stageId: 1,
  difficulty: "normal",
  score: 5000,
  clearTime: 120000  // ミリ秒
}
```

---

## 8. 現状の課題

### 8.1 バグ・不具合

| 優先度 | 内容 | 状態 |
|--------|------|------|
| - | 特になし | - |

### 8.2 未実装・改善点

| 優先度 | 内容 | 備考 |
|--------|------|------|
| 高 | 画像アセットの作成 | プレースホルダーで動作中 |
| 高 | サウンド実装 | 読み込み処理は実装済み |
| 中 | 壁タイプ選択UI | 現在は基本の壁のみ使用可能 |
| 中 | ポーズ機能 | UIのみ、機能未実装 |
| 低 | タッチ対応 | モバイル向け |
| 低 | パフォーマンス最適化 | 大量の敵で重くなる可能性 |

### 8.3 既知の制限

- `file://` プロトコルではJSONが読み込めない（DefaultDataで代替）
- 壁タイプ選択UIが未実装のため、fire/ice等の壁が使えない
- ランキングは1ステージ20件まで

---

## 9. ネクストアクション

### Phase 1: ビジュアル強化（優先度: 高）

1. **敵スプライト作成**（10種）
   - サイバーパンク調のドット絵
   - 各2-4フレームのアニメーション

2. **CPU/コアデザイン**
   - 回路基板風のデザイン
   - 表情4パターン

3. **背景画像作成**
   - タイトル画面用
   - ゲーム画面用（回路基板パターン）

### Phase 2: サウンド実装（優先度: 高）

1. **効果音**
   - 壁描画音
   - 敵ヒット音
   - 敵撃破音
   - ボマー爆発音
   - ステージクリア音
   - ゲームオーバー音

2. **BGM**
   - タイトル画面
   - ゲームプレイ（テンポ可変だと良い）
   - リザルト画面

### Phase 3: 機能追加（優先度: 中）

1. **壁タイプ選択UI**
   - 画面下部にアイコン表示
   - クリックまたはキーボードで切り替え

2. **ポーズ機能完成**
   - 一時停止状態の管理
   - 再開/リトライ/タイトルへ戻る

3. **チュートリアル**
   - ステージ1で操作説明
   - 特殊敵登場時にヒント表示

### Phase 4: 品質向上（優先度: 低）

1. **パフォーマンス最適化**
   - オブジェクトプール
   - 画面外オブジェクトの処理スキップ

2. **モバイル対応**
   - タッチイベント対応
   - レスポンシブUI

3. **多言語対応**
   - 英語対応

---

## 10. 開発環境・デプロイ

### 10.1 ローカル開発

```bash
# 任意のHTTPサーバーで起動
npx http-server . -p 8080

# または Python
python -m http.server 8080

# ブラウザでアクセス
http://localhost:8080
```

**注意**: `file://` プロトコルでも動作するが、JSONはDefaultDataにフォールバック

### 10.2 Cloudflare Pages デプロイ

**設定ファイル**: `wrangler.json`

```json
{
  "name": "firewall-draw",
  "compatibility_date": "2026-01-23",
  "assets": {
    "directory": "./"
  }
}
```

**デプロイ手順**:
```bash
# Cloudflare CLIでデプロイ
npx wrangler pages deploy ./
```

または GitHub連携で自動デプロイ

### 10.3 Workers API デプロイ

**設定ファイル**: `workers/wrangler.toml`

```toml
name = "firewall-ranking-api"
main = "ranking-api.js"
compatibility_date = "2026-01-23"

[[kv_namespaces]]
binding = "RANKINGS"
id = "29e36f63a9114bbaaa00b34200c95adc"
```

**デプロイ手順**:
```bash
cd workers
npx wrangler deploy
```

### 10.4 Git リポジトリ

**URL**: https://github.com/KamiHitoe1031/FIREWALLDRAW.git

**ブランチ**: main

---

## 付録

### A. 主要ファイル一覧と役割

| ファイル | 行数 | 役割 |
|----------|------|------|
| GameScene.js | ~1200 | メインゲームロジック、Wall/Enemyクラス |
| PreloadScene.js | ~140 | アセット読み込み、フォールバック処理 |
| AssetManager.js | ~220 | スプライト/プレースホルダー管理 |
| PlaceholderConfig.js | ~160 | プレースホルダー設定 |
| DefaultData.js | ~340 | フォールバックデータ |
| SaveManager.js | ~150 | セーブ/ロード |
| RankingManager.js | ~170 | ランキングAPI通信 |
| ResultScene.js | ~400 | リザルト画面、ランキング送信 |
| RankingScene.js | ~300 | ランキング表示画面 |

### B. 参考ドキュメント

- `docs/visual_design_proposal.md` - ビジュアルデザイン提案書
- Phaser 3 公式ドキュメント: https://phaser.io/phaser3

---

*本ドキュメントは FIREWALL DRAW プロジェクトの引継ぎ資料です。*
